<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<link rel="stylesheet" href="mmap.css">
	<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=true&amp;libraries=places">
	</script>

	<script type="text/javascript">
		var lat = 0;
		var lng = 0;
		var request = new XMLHttpRequest();
		var me = new google.maps.LatLng(lat, lng);
		var options = {
			zoom: 8,
			center: me,
			mapTypeId: google.maps.MapTypeId.ROADMAP
		};
		var map;
		var marker;
		var infowindow = new google.maps.InfoWindow();
		var places;

		function init()
		{
			map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
			console.log("Call before getMyLocation()");
			getMyLocation();
			console.log("Call after getMyLocation()");
		}

		function getMyLocation() {
			console.log("In getMyLocation()");
			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(function(position){
					lat = position.coords.latitude;
					lng = position.coords.longitude;
					renderMap();
				});
			} else {
				alert("Your browser does not support geolocation.");
			}
			console.log("Leaving getMyLocation");
		}

		function renderMap()
		{
			me = new google.maps.LatLng(lat, lng);
			map.panTo(me);

			marker = new google.maps.Marker({
				position: me,
				title: "Here I Am!"
			});
			marker.setMap(map);

			google.maps.event.addListener(marker, 'click', function() {
				infowindow.setContent(marker.title);
				infowindow.open(map, marker);
			});

			var request = {
				location: me,
				radius: '500',
				types: ['food']
			};

			service = new google.maps.places.PlacesService(map);
			service.search(request, callback);
		}

		function callback(results, status)
		{
			if (status == google.maps.places.PlacesServiceStatus.OK) {
				alert("Got places back!");
				places = results;
				for (var i = 0; i < results.length; i++) {
					createMarker(results[i]);
				}
			}
		}

		function createMarker(place)
		{
			var placeLoc = place.geometry.location;
			var marker = new google.maps.Marker({
				map: map,
				position: place.geometry.location
			});

			google.maps.event.addListener(marker, 'click', function() {
				infowindow.close();
				infowindow.setContent(place.name);
				infowindow.open(map, this);
			});
		}

		/*
		function initialize() {
			if (navigator.geolocation) {
				lat = 0;
				lng = 0;
				navigator.geolocation.getCurrentPosition(
					function(position) { 
					lat = position.coords.latitude;
					lng = position.coords.longitude;
				},
					function() {
						console.log("Your browser does not support geolocation.");
					});
			}
			latlng = new google.maps.LatLng(lat, lng, false);
			console.log(lat + " " + lng + "; " + latlng.lat() + " " + latlng.lng());
			var mapOptions = {
				center: { lat: latlng.lat(), lng: latlng.lng()},
				zoom: 8
			};
			var map = new google.maps.Map(document.getElementById('map_canvas'), mapOptions);
		}
		google.maps.event.addDomListener(window, 'load', initialize);
		*/
	</script>
</head>

<body>
	<div id="map_canvas"></div>
</body>

</html>
