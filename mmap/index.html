<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<link rel="stylesheet" href="mmap.css">
	<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=true&amp;libraries=places"></script>

	<script>
		var myLogin = "BenHarris";
		var lat = 0;
		var lng = 0;
		response = null;
		datastoreRequest = new XMLHttpRequest();
		var me = new google.maps.LatLng(lat, lng);

		var options = {
			zoom: 13,
			center: me,
			mapTypeId: google.maps.MapTypeId.ROADMAP
		};

		var map;
		var marker;
		var infowindow = new google.maps.InfoWindow();

		function init()
		{
			map = new google.maps.Map(document.getElementById("map_canvas"), options);
			console.log("Call before getMyLocation()");
			getMyLocation();
			console.log("Call after getMyLocation()");
		}

		function getMyLocation() {
			console.log("In getMyLocation()");
			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(function(position) {
					lat = position.coords.latitude;
					lng = position.coords.longitude;

					datastoreRequest.open("POST", "https://secret-about-box.herokuapp.com/sendLocation", true);
					datastoreRequest.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
					datastoreRequest.send("login=" + myLogin + "&lat=" + lat + "&lng=" + lng);

					console.log("After send info");
					console.log(datastoreRequest);
					datastoreRequest.onreadystatechange = function()
					{
						console.log("Ready state changed");
						if (datastoreRequest.readystate == 4 && datastoreRequest.status == 200) {
								response = JSON.parse(datastoreRequest.responseText);
			 
								console.log("Response is " + response);

								renderMap(response);
								console.log("After rendering");
							}
					}
				});
			} else {
				alert("Your browser does not support geolocation.");
			}
			console.log("Leaving getMyLocation");
		}



		function renderMap(people)
		{
			console.log("In renderMap");
			me = new google.maps.LatLng(lat, lng);
			map.panTo(me);

			marker = new google.maps.Marker({
				position: me,
				title: myLogin
			});

			marker.setMap(map);

			google.maps.event.addListener(marker, 'click', function() {
				infowindow.setContent(marker.title);
				infowindow.open(map, marker);
			});

			displayPeople(people);
		}

		function displayPeople(people)
		{
			for (var i = 0; i < people.length; i++) {
				createMarker(people[i]);
			}
		}

		function createMarker(person)
		{
			var theirLatLng = new google.maps.LatLng(person.lat, person.lng);
			var marker = new google.maps.Marker({
				map: map,
				position: theirLatLng,
				title: person.login
			});

			google.maps.event.addListener(marker, 'click', function() {
				infowindow.close();
				infowindow.setContent(person.login);
				infowindow.open(map, this);
			});
		}
	</script>
</head>

<body onload="init()">
	<div id="map_canvas"></div>
</body>

</html>
